<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokalbis su {{ other_user.first_name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-active { background-color: #eff6ff; color: #1d4ed8; font-weight: 600; }
        #chat-log::-webkit-scrollbar { display: none; }
        #chat-log { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen bg-gray-100">
        
        {% if user_type == 'nuomotojas' %}
            {% include 'nomoklis_app/_sidebar.html' %}
        {% else %}
            {% include 'nomoklis_app/_tenant_sidebar.html' %}
        {% endif %}

        <div class="flex-1 flex flex-col overflow-hidden">
            {% include 'nomoklis_app/_header.html' %}

            <main class="flex-1 flex flex-col overflow-hidden p-4">
                <div class="flex-1 flex flex-col bg-white shadow-md rounded-lg overflow-hidden">
                    
                    <div class="p-4 border-b flex items-center space-x-4 bg-gray-50">
                        <div class="relative">
                            <div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-xl">{{ other_user.first_name|first|upper }}</div>
                            <span class="absolute bottom-0 right-0 block h-3 w-3 rounded-full bg-green-400 ring-2 ring-white"></span>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-gray-800">{{ other_user.first_name }} {{ other_user.last_name }}</h2>
                            <p class="text-sm text-gray-500">Aktyvus dabar</p>
                        </div>
                    </div>

                    <div id="chat-log" class="flex-1 p-6 space-y-6 overflow-y-auto bg-gray-50">
                        {% for message in previous_messages %}
                            {% if message.sender == user %}
                                <div class="flex items-end justify-end">
                                    <div class="order-1 max-w-xs md:max-w-md bg-blue-600 text-white p-3 rounded-l-2xl rounded-tr-2xl">
                                        <p class="text-sm">{{ message.content }}</p>
                                        <p class="text-xs text-blue-200 text-right mt-1">{{ message.timestamp|date:"H:i" }}</p>
                                    </div>
                                    <div class="order-2 flex-shrink-0 w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center text-sm font-bold ml-3">{{ user.first_name|first|upper }}</div>
                                </div>
                            {% else %}
                                <div class="flex items-end">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-bold mr-3">{{ message.sender.first_name|first|upper }}</div>
                                    <div class="bg-white p-3 rounded-r-2xl rounded-tl-2xl shadow-sm max-w-xs md:max-w-md">
                                        <p class="text-sm text-gray-800">{{ message.content }}</p>
                                        <p class="text-xs text-gray-500 text-right mt-1">{{ message.timestamp|date:"H:i" }}</p>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div class="p-4 bg-white border-t">
                        <div class="flex items-center space-x-3">
                            <input id="chat-message-input" type="text" placeholder="Įrašykite savo žinutę..." class="w-full px-4 py-2 bg-gray-100 border border-transparent rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition">
                            <button id="chat-message-submit" class="flex-shrink-0 w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center hover:bg-blue-700 transition">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.886l4.107 4.107a1 1 0 010 1.414l-4.107 4.107a1 1 0 01-1.414-1.414L12.586 10 9.48 6.894a1 1 0 011.414-1.414z" clip-rule="evenodd" /><path d="M4.894 2.886l4.107 4.107a1 1 0 010 1.414L4.894 12.514a1 1 0 01-1.414-1.414L6.586 10 3.48 6.894A1 1 0 014.894 2.886z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    {{ room_name|json_script:"room-name" }}
    {{ user.username|json_script:"user-username" }}
    {{ user.first_name|first|upper|json_script:"user-initial" }}
    {{ other_user.first_name|first|upper|json_script:"tenant-initial" }}

    <script>
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        const currentUsername = JSON.parse(document.getElementById('user-username').textContent);
        const userInitial = JSON.parse(document.getElementById('user-initial').textContent);
        const tenantInitial = JSON.parse(document.getElementById('tenant-initial').textContent);
        
        const chatLog = document.getElementById('chat-log');
        const messageInput = document.getElementById('chat-message-input');
        const messageSubmit = document.getElementById('chat-message-submit');

        chatLog.scrollTop = chatLog.scrollHeight;

        const chatSocket = new WebSocket('ws://' + window.location.host + '/chat/' + roomName + '/');

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const isMe = data.username === currentUsername;
            const timestamp = new Date().toLocaleTimeString('lt-LT', { hour: '2-digit', minute: '2-digit' });

            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-end ${isMe ? 'justify-end' : ''}`;

            const messageBubble = document.createElement('div');
            const avatar = document.createElement('div');
            
            const messageContent = document.createElement('p');
            messageContent.className = 'text-sm';
            messageContent.innerText = data.message;
            
            const timePara = document.createElement('p');
            timePara.className = 'text-xs text-right mt-1';
            timePara.innerText = timestamp;

            messageBubble.appendChild(messageContent);
            messageBubble.appendChild(timePara);

            if (isMe) {
                messageBubble.className = 'order-1 max-w-xs md:max-w-md bg-blue-600 text-white p-3 rounded-l-2xl rounded-tr-2xl';
                timePara.classList.add('text-blue-200');
                avatar.className = 'order-2 flex-shrink-0 w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center text-sm font-bold ml-3';
                avatar.innerText = userInitial;
                messageWrapper.appendChild(messageBubble);
                messageWrapper.appendChild(avatar);
            } else {
                messageBubble.className = 'bg-white p-3 rounded-r-2xl rounded-tl-2xl shadow-sm max-w-xs md:max-w-md';
                messageContent.classList.add('text-gray-800');
                timePara.classList.add('text-gray-500');
                avatar.className = 'flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-bold mr-3';
                avatar.innerText = tenantInitial;
                messageWrapper.appendChild(avatar);
                messageWrapper.appendChild(messageBubble);
            }
            
            chatLog.appendChild(messageWrapper);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        chatSocket.onclose = function(e) { console.error('Pokalbių lizdas netikėtai užsidarė'); };
        
        messageInput.focus();
        messageInput.onkeyup = function(e) { if (e.key === 'Enter') { messageSubmit.click(); } };

        messageSubmit.onclick = function(e) {
            const message = messageInput.value;
            if (message.trim() === '') return;
            chatSocket.send(JSON.stringify({'message': message}));
            messageInput.value = '';
            messageInput.focus();
        };
    </script>
</body>
</html>