{% extends 'nomoklis_app/_tenant_base.html' %}

{% block title %}NT Paie≈°ka{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    .results-list::-webkit-scrollbar {
        width: 6px;
    }

    .results-list::-webkit-scrollbar-track {
        background: #f1f1ff;
    }

    .results-list::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 6px;
    }

    .leaflet-popup-content-wrapper {
        border-radius: 0.5rem;
    }

    [x-cloak] {
        display: none !important;
    }
</style>
{% endblock %}

{% block main_class %}bg-white{% endblock %}
{% block container_class %}p-0 max-w-full h-full{% endblock %}

{% block content %}
<div class="w-full h-full flex flex-col">
    {# Headeris dabar yra ƒçia, o ne baziniame ≈°ablone, nes ≈°io puslapio strukt≈´ra kitokia #}
    <div class="p-4 border-b flex-shrink-0" x-data="{ openDropdown: null }">
    <form method="get" action="{% url 'property_search' %}" class="space-y-3">
        <div class="flex flex-wrap items-center gap-2">
            
            {# City Input (Shorter) #}
            <input type="text" name="city" value="{{ request.GET.city|default:'' }}"
                class="w-40 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                placeholder="Miestas">

            {# Property Type Select #}
            <select name="property_type" class="w-40 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                <option value="">Visi NT tipai</option>
                {% for value, display in property_types %}
                <option value="{{ value }}" {% if request.GET.property_type == value %}selected{% endif %}>{{ display }}</option>
                {% endfor %}
            </select>

            {# Price Inputs #}
            <div class="flex items-center">
                <input type="number" name="min_price" value="{{ request.GET.min_price|default:'' }}"
                    placeholder="Kaina nuo" class="w-24 px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                <input type="number" name="max_price" value="{{ request.GET.max_price|default:'' }}" placeholder="iki"
                    class="w-24 px-3 py-2 border-t border-b border-r border-gray-300 rounded-r-md shadow-sm focus:outline-none focusÎßÅ-blue-500 focus:border-blue-500 text-sm">
            </div>
            
            {# Rooms Inputs #}
            <div class="flex items-center">
                <input type="number" name="min_rooms" value="{{ request.GET.min_rooms|default:'' }}"
                    placeholder="Kamb. nuo" class="w-24 px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                <input type="number" name="max_rooms" value="{{ request.GET.max_rooms|default:'' }}" placeholder="iki"
                    class="w-24 px-3 py-2 border-t border-b border-r border-gray-300 rounded-r-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
            </div>

            {# More Filters Dropdown #}
            <div class="relative">
                <button type="button" @click="openDropdown = (openDropdown === 'more' ? null : 'more')"
                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium hover:bg-gray-100 shadow-sm"
                    :class="{ 'bg-gray-200': '{{ request.GET.min_area }}' || '{{ request.GET.max_area }}' || '{{ request.GET.has_balcony }}' || '{{ request.GET.has_parking }}' || '{{ request.GET.pets_allowed }}' || '{{ request.GET.is_furnished }}' || '{{ request.GET.has_appliances }}' || '{{ request.GET.residence_declaration_allowed }}' }">
                    Daugiau filtr≈≥
                </button>
                <div x-show="openDropdown === 'more'" @click.away="openDropdown = null" x-cloak
                    class="absolute top-full mt-2 w-80 bg-white border rounded-lg shadow-xl z-20">
                    <div class="p-4 space-y-4">
                        {# Area Inputs #}
                        <div>
                            <label class="text-sm font-semibold text-gray-700">Plotas, m¬≤</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="number" name="min_area" value="{{ request.GET.min_area|default:'' }}"
                                    placeholder="Nuo" class="w-full border-gray-300 rounded-md text-sm">
                                <input type="number" name="max_area" value="{{ request.GET.max_area|default:'' }}"
                                    placeholder="Iki" class="w-full border-gray-300 rounded-md text-sm">
                            </div>
                        </div>
                        {# Amenities #}
                        <div class="pt-2">
                            <label class="text-sm font-semibold text-gray-700">Patogumai</label>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-2 mt-2">
                                <label class="flex items-center"><input type="checkbox" name="has_balcony" {% if request.GET.has_balcony %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-blue-600"><span class="ml-2 text-sm text-gray-600">Balkonas</span></label>
                                <label class="flex items-center"><input type="checkbox" name="has_parking" {% if request.GET.has_parking %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-blue-600"><span class="ml-2 text-sm text-gray-600">Parkavimas</span></label>
                                <label class="flex items-center"><input type="checkbox" name="pets_allowed" {% if request.GET.pets_allowed %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-blue-600"><span class="ml-2 text-sm text-gray-600">Leid≈æiami gyv≈´nai</span></label>
                                <label class="flex items-center"><input type="checkbox" name="is_furnished" {% if request.GET.is_furnished %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-blue-600"><span class="ml-2 text-sm text-gray-600">Su baldais</span></label>
                                <label class="flex items-center"><input type="checkbox" name="has_appliances" {% if request.GET.has_appliances %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-blue-600"><span class="ml-2 text-sm text-gray-600">Su buitine technika</span></label>
                                <label class="flex items-center"><input type="checkbox" name="residence_declaration_allowed" {% if request.GET.residence_declaration_allowed %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-blue-600"><span class="ml-2 text-sm text-gray-600">Leid≈æiama deklaruoti gyv. vietƒÖ</span></label>
                            </div>
                        </div>
                        <button type="button" @click="openDropdown = null"
                            class="w-full px-4 py-2 bg-gray-200 text-gray-700 text-sm font-semibold rounded-md hover:bg-gray-300 mt-2">U≈ædaryti</button>
                    </div>
                </div>
            </div>

            {# Search Button #}
            <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Ie≈°koti
            </button>

            {# Clear Button #}
            <a href="{% url 'property_search' %}" class="text-sm text-gray-500 hover:text-blue-600 hover:underline self-center">
                I≈°valyti filtrus
            </a>
        </div>
    </form>
</div>
    <div class="flex-grow flex overflow-hidden">
        <div class="w-full lg:w-1/2 xl:w-2/5 flex flex-col border-r border-gray-200">
            <div class="flex-grow overflow-y-auto results-list p-4">
                <div class="mb-4 px-2">
                    <h2 class="text-lg font-bold text-gray-800">Rasta {{ properties.count }} nuomos pasi≈´lym≈≥</h2>
                </div>
                <div id="property-list-container" class="grid grid-cols-1 gap-4">
                    {% for property in properties %}
                    <div x-data="{ isSaved: {% if property.id in saved_property_ids %}true{% else %}false{% endif %} }"
                        id="property-card-{{ property.id }}" data-lat="{{ property.latitude }}"
                        data-lon="{{ property.longitude }}"
                        class="bg-white rounded-lg border border-gray-200 hover:border-blue-500 overflow-hidden group transition-all duration-300 cursor-pointer">
                        <div class="flex relative">
                            {% if user.is_authenticated and user.profile.user_type == 'nuomininkas' %}
                            <button
                                @click.prevent="fetch('{% url 'toggle_save_property' property.id %}', { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} }).then(response => response.json()).then(data => isSaved = data.is_saved)"
                                class="absolute top-3 right-3 z-10 p-2 bg-white/70 rounded-full backdrop-blur-sm hover:bg-white transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                                        :class="isSaved ? 'fill-red-500 text-red-500' : 'fill-none'" />
                                </svg>
                            </button>
                            {% endif %}
                            <img class="w-1/3 h-40 object-cover"
                                src="{% if property.images.first %}{{ property.images.first.image.url }}{% else %}https://placehold.co/400x300/d1d5db/333333?text=Nƒóra+nuotraukos{% endif %}"
                                alt="{{ property.street }}">
                            <div class="p-4 flex-1">
                                <p class="font-bold text-lg text-gray-800">{{ property.rent_price|floatformat:"0" }} ‚Ç¨/mƒón.</p>
                                {% if property.available_from %}
                                <div class="mt-1 inline-block px-2 py-1 bg-amber-50 border border-amber-200 rounded-md">
                                    <p class="text-xs font-semibold text-amber-700">üìÖ Laisvas nuo {{ property.available_from|date:"Y-m-d" }}</p>
                                </div>
                                {% endif %}
                                <p class="text-md text-gray-700 mt-1 font-semibold truncate">{{ property.street }} {{ property.house_number }}, {{ property.city }}</p>
                                <p class="text-sm text-gray-500 mt-2">{{ property.rooms }} kamb. &bull; {{ property.area|floatformat:"0" }} m¬≤ &bull; {{ property.floor }}/{{ property.total_floors }} auk≈°tas</p>
                                <button data-url="{% url 'property_detail_view' property.id %}"
                                    class="show-details-btn mt-2 text-sm font-semibold text-blue-600 hover:underline">Daugiau
                                    informacijos</button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-gray-600 col-span-full text-center py-10">Pagal j≈´s≈≥ paie≈°kos kriterijus, laisv≈≥ NT
                        objekt≈≥ nerasta.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="hidden lg:block w-1/2 xl:w-3/5 relative">
            <div id="map" class="absolute inset-0 z-10"></div>
        </div>
    </div>
</div>

<div id="modal-backdrop-details"
    class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
    <div id="modal-content-details" class="relative"></div>
</div>

<div id="modal-backdrop-generic"
    class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-[60]">
    <div id="modal-content-generic" class="relative"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- PATAISYMAS: I≈°saugome nuorodas ƒØ visus modalinius langus ---
        const detailsBackdrop = document.getElementById('modal-backdrop-details');
        const detailsContent = document.getElementById('modal-content-details');
        const genericBackdrop = document.getElementById('modal-backdrop-generic');
        const genericContent = document.getElementById('modal-content-generic');

        // --- PATAISYMAS: I≈°pleƒçiame paspaudim≈≥ apdorojimƒÖ ---
        document.body.addEventListener('click', async function (event) {
            // Ie≈°kome paspaust≈≥ mygtuk≈≥. Naudojame .closest(), kad veikt≈≥ net jei paspaudƒóme ant ikonos mygtuko viduje
            const detailsBtn = event.target.closest('.show-details-btn');
            const requestBtn = event.target.closest('.show-request-btn');
            const reviewsBtn = event.target.closest('.show-reviews-btn');

            // Rodyti detalios informacijos langƒÖ
            if (detailsBtn) {
                event.preventDefault(); // Svarbu, kad nenukreipt≈≥ ƒØ nuorodƒÖ, jei mygtukas yra <a>
                try {
                    const response = await fetch(detailsBtn.dataset.url);
                    detailsContent.innerHTML = await response.text();
                    detailsBackdrop.classList.remove('hidden');
                } catch (error) { console.error("Nepavyko u≈ækrauti detalios informacijos:", error); }
            }

            // Rodyti u≈æklausos arba atsiliepim≈≥ langƒÖ (naudojame bendrinƒØ modalƒÖ)
            else if (requestBtn || reviewsBtn) {
                event.preventDefault();
                const btn = requestBtn || reviewsBtn; // Nustatome, kuris mygtukas buvo paspaustas
                try {
                    const response = await fetch(btn.dataset.url);
                    genericContent.innerHTML = await response.text();
                    genericBackdrop.classList.remove('hidden');
                } catch (error) { console.error("Nepavyko u≈ækrauti antrinio turinio:", error); }
            }

            // U≈ædaryti detalios informacijos langƒÖ
            // Tikriname ar paspausta ant fono, ar ant u≈ædarymo mygtuko
            if (event.target === detailsBackdrop || event.target.closest('.close-modal-btn')) {
                detailsBackdrop.classList.add('hidden');
                detailsContent.innerHTML = ''; // I≈°valome turinƒØ
            }

            // U≈ædaryti bendrinƒØ (u≈æklaus≈≥/atsiliepim≈≥) langƒÖ
            if (event.target === genericBackdrop || event.target.closest('.close-reviews-btn') || event.target.closest('.cancel-request-btn')) {
                genericBackdrop.classList.add('hidden');
                genericContent.innerHTML = ''; // I≈°valome turinƒØ
            }
        });

        // ≈Ωemƒólapio inicializavimas
        const mapElement = document.getElementById('map');
        if (mapElement) {
            const map = L.map(mapElement).setView([54.6872, 25.2797], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const markers = L.layerGroup().addTo(map);
            const markerObjects = {};

            const colorMapping = {
                'butas': '#3B82F6', // blue-500
                'namas': '#10B981', // green-500
                'kambarys': '#F59E0B', // amber-500
                'default': '#6B7280' // gray-500
            };

            const getIcon = (propertyType) => {
                const color = colorMapping[propertyType] || colorMapping['default'];
                const svgIconHtml = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="40" viewBox="0 0 24 40">
                        <path d="M12 0C7.03 0 3 4.03 3 9c0 5.25 9 16 9 16s9-10.75 9-16c0-4.97-4.03-9-9-9z" fill="${color}" stroke="#fff" stroke-width="1.5"/>
                        <circle cx="12" cy="9" r="3" fill="white"/>
                    </svg>`;

                return L.divIcon({
                    html: svgIconHtml,
                    className: '',
                    iconSize: [28, 40],
                    iconAnchor: [14, 40],
                    popupAnchor: [0, -40]
                });
            };

            const apiUrl = "{% url 'property_locations_api' %}" + window.location.search;
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    data.forEach(prop => {
                        const propId = prop.popup_url.match(/(\d+)\/?$/)[1];
                        if (prop.lat && prop.lon) {
                            const marker = L.marker([prop.lat, prop.lon], { icon: getIcon(prop.property_type) });
                            const popupContent = `<div class="p-1"><p class="font-bold">${prop.title}</p><p>${prop.price}</p><button data-url="${prop.popup_url}" class="show-details-btn text-blue-600 hover:underline cursor-pointer font-semibold">Daugiau</button></div>`;
                            marker.bindPopup(popupContent);
                            markers.addLayer(marker);
                            markerObjects[propId] = marker;
                        }
                    });
                })
                .catch(error => console.error('Klaida gaunant objekt≈≥ lokacijas:', error));

            const propertyCards = document.querySelectorAll('[id^="property-card-"]');
            let activeCard = null;

            propertyCards.forEach(card => {
                const propId = card.id.split('-')[2];
                card.addEventListener('click', (event) => {
                    if (event.target.closest('button')) {
                        return;
                    }

                    if (activeCard) {
                        activeCard.classList.remove('ring-2', 'ring-blue-500', 'shadow-lg');
                    }

                    activeCard = card;
                    activeCard.classList.add('ring-2', 'ring-blue-500', 'shadow-lg');

                    if (markerObjects[propId]) {
                        map.flyTo([card.dataset.lat, card.dataset.lon], 15);
                        markerObjects[propId].openPopup();
                    }
                });
            });
        }
    });
</script>
{% endblock %}